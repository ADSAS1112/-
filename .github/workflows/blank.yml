<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼ æ°å®¶é£ä¼ æ‰¿</title>
    <style>
        body { font-family: "å®‹ä½“", serif; margin: 0; padding: 0; background: #f8f5f0; }
        .container { display: flex; min-height: 100vh; }
        .sidebar { width: 30%; max-width: 180px; background: #e9e3d7; padding: 10px; border-right: 1px solid #d4c9b7; }
        .main-content { flex: 1; padding: 10px; }
        .panel { background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h2 { color: #8B0000; margin-top: 0; }
        h3 { color: #8B4513; }
        button { background: #8B0000; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; margin: 5px 0; width: 100%; }
        .btn-group { display: flex; gap: 10px; }
        .btn-group button { flex: 1; }
        .stat { display: flex; justify-content: space-between; margin-bottom: 5px; padding: 5px; background: #f5f0e5; border-radius: 3px; }
        .progress { height: 10px; background: #eee; border-radius: 5px; margin: 5px 0 15px; }
        .progress-bar { height: 100%; border-radius: 5px; background: #8B0000; }
        .alert { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .special { background: #d1ecf1; color: #0c5460; }
        .time-alert { background: #f8d7da; color: #721c24; animation: pulse 1s infinite; }
        .task { border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .badge { background: #8B0000; color: white; padding: 2px 5px; border-radius: 50%; font-size: 0.8em; margin-left: 5px; }
        .sidebar h3 { color: #8B0000; margin-top: 0; }
        .inventory-item { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .stat-change { animation: pulse 0.5s ease-in-out; }
        .achievement-unlock { animation: glow 1s ease-in-out infinite alternate; }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 5px #8B0000; }
            to { box-shadow: 0 0 20px #8B0000; }
        }
        
        @keyframes time-pulse {
            0% { background-color: #f8d7da; }
            50% { background-color: #ffcccc; }
            100% { background-color: #f8d7da; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <h3>å®¶æ—çŠ¶æ€</h3>
            
            <div class="stat">
                <span>é“¶å…ƒ</span>
                <span id="sidebar-silver">8</span>
            </div>
            
            <div class="stat">
                <span>å­å¿ƒå€¼</span>
                <div style="width: 100%">
                    <div id="sidebar-filial">50</div>
                    <div class="progress">
                        <div id="sidebar-filialBar" class="progress-bar" style="width: 50%"></div>
                    </div>
                </div>
            </div>
            
            <div class="stat" id="time-display">
                <span>å‰©ä½™æ—¶é—´</span>
                <span id="sidebar-time">5:00</span>
            </div>
            
            <h3>ç‰©å“</h3>
            <div id="inventory">
                <div class="inventory-item">
                    <span>å¤§ç±³</span>
                    <span id="sidebar-rice">0æ–¤</span>
                </div>
                <div class="inventory-item">
                    <span>é±¼</span>
                    <span id="sidebar-fish">0æ¡</span>
                </div>
                <div class="inventory-item">
                    <span>æ‰‹å·¥è‰ºå“</span>
                    <span id="sidebar-craft">0ä»¶</span>
                </div>
            </div>
            
            <h3>æˆå°±</h3>
            <div id="achievements">
                <div class="inventory-item" id="achievement-1">
                    <span>åˆéœ²é”‹èŠ’</span>
                    <span id="achievement-1-status">æœªè§£é”</span>
                </div>
                <div class="inventory-item" id="achievement-2">
                    <span>å®¶æ—æ¥·æ¨¡</span>
                    <span id="achievement-2-status">æœªè§£é”</span>
                </div>
                <div class="inventory-item" id="achievement-3">
                    <span>å¾·é«˜æœ›é‡</span>
                    <span id="achievement-3-status">æœªè§£é”</span>
                </div>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <div id="story">
                <div id="passage">
                    <div class="panel">
                        <h2>å¼ æ°å®¶é£</h2>
                        <p>ä½ å°†åœ¨5åˆ†é’Ÿå†…ç®¡ç†å®¶æ—äº‹åŠ¡ï¼Œç§¯ç´¯å­å¿ƒå€¼å’Œè´¢å¯Œã€‚</p>
                        <button onclick="startGame()">å¼€å§‹ä¼ æ‰¿ä¹‹æ—…</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        const state = {
            silver: 8,
            filial: 50,
            scene: "start",
            tasks: [],
            lastRandomEvent: 0,
            days: 0,
            inventory: {
                rice: 0,
                fish: 0,
                craft: 3 // åˆå§‹3ä»¶æ‰‹å·¥è‰ºå“
            },
            achievements: {
                "achievement-1": false, // å­å¿ƒå€¼è¾¾åˆ°70
                "achievement-2": false, // å­å¿ƒå€¼è¾¾åˆ°100
                "achievement-3": false  // å­å¿ƒå€¼è¾¾åˆ°150
            },
            unlockedFeatures: [],
            gameTime: 5 * 60, // 5åˆ†é’Ÿï¼Œä»¥ç§’ä¸ºå•ä½
            gameStarted: false,
            timer: null
        };

        // å­å¿ƒå€¼é˜ˆå€¼å’Œå¯¹åº”çš„å¥–åŠ±
        const filialThresholds = [
            { value: 70, reward: "è§£é”å®—ç¥ æ‰©å»ºåŠŸèƒ½", effect: () => state.unlockedFeatures.push("ancestor-hall") },
            { value: 100, reward: "è·å¾—ç¥–ä¼ ç§˜æ–¹", effect: () => { state.inventory.craft += 5; state.silver += 10; } },
            { value: 150, reward: "å®¶æ—å£°èª‰æå‡", effect: () => { state.silver += 20; state.filial += 10; } }
        ];

        // æ•°å€¼å˜åŒ–åŠ¨ç”»
        function animateValue(elementId, start, end, duration) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const range = end - start;
            const minTimer = 50;
            let stepTime = Math.abs(Math.floor(duration / range));
            
            stepTime = Math.max(stepTime, minTimer);
            
            let startTime = new Date().getTime();
            let endTime = startTime + duration;
            let timer;
            
            function run() {
                let now = new Date().getTime();
                let remaining = Math.max((endTime - now) / duration, 0);
                let value = Math.round(end - (remaining * range));
                element.textContent = value;
                
                if (value == end) {
                    clearInterval(timer);
                }
            }
            
            timer = setInterval(run, stepTime);
            run();
        }

        // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        // æ›´æ–°è®¡æ—¶å™¨
        function updateTimer() {
            const timeDisplay = document.getElementById("sidebar-time");
            if (!timeDisplay) return;
            
            state.gameTime--;
            timeDisplay.textContent = formatTime(state.gameTime);
            
            // æ—¶é—´å°‘äº1åˆ†é’Ÿæ—¶æ˜¾ç¤ºè­¦å‘Š
            if (state.gameTime <= 60) {
                document.getElementById("time-display").classList.add("time-alert");
            }
            
            // æ—¶é—´ç»“æŸ
            if (state.gameTime <= 0) {
                clearInterval(state.timer);
                showEnding();
            }
        }

        // æ£€æŸ¥å­å¿ƒå€¼é˜ˆå€¼
        function checkFilialThresholds() {
            let triggered = false;
            
            filialThresholds.forEach(threshold => {
                if (state.filial >= threshold.value && !state.achievements[`achievement-${threshold.value/50}`]) {
                    state.achievements[`achievement-${threshold.value/50}`] = true;
                    threshold.effect();
                    
                    // æ˜¾ç¤ºç‰¹æ®Šäº‹ä»¶æç¤º
                    showAlert("special", `ğŸ‰ æ­å–œï¼å­å¿ƒå€¼è¾¾åˆ°${threshold.value}ï¼<br>å¥–åŠ±ï¼š${threshold.reward}`);
                    
                    // æ›´æ–°æˆå°±UI
                    updateAchievements();
                    
                    triggered = true;
                }
            });
            
            return triggered;
        }

        // æ›´æ–°æˆå°±UI
        function updateAchievements() {
            for (const [key, value] of Object.entries(state.achievements)) {
                const statusEl = document.getElementById(`${key}-status`);
                const achievementEl = document.getElementById(key);
                
                if (statusEl && achievementEl && value) {
                    statusEl.textContent = "å·²è§£é”";
                    statusEl.className = "success";
                    achievementEl.className = "inventory-item achievement-unlock";
                    
                    // 3ç§’åç§»é™¤å‘å…‰æ•ˆæœ
                    setTimeout(() => {
                        achievementEl.classList.remove("achievement-unlock");
                    }, 3000);
                }
            }
        }

        // æ›´æ–°UI
        function updateUI() {
            // æ›´æ–°ä¾§è¾¹æ æ•°å€¼ï¼ˆä½¿ç”¨åŠ¨ç”»ï¼‰
            animateValue("sidebar-silver", parseInt(document.getElementById("sidebar-silver").textContent || state.silver), state.silver, 500);
            animateValue("sidebar-filial", parseInt(document.getElementById("sidebar-filial").textContent || state.filial), state.filial, 500);
            document.getElementById("sidebar-filialBar").style.width = `${state.filial}%`;
            
            // æ›´æ–°ç‰©å“æ 
            document.getElementById("sidebar-rice").textContent = `${state.inventory.rice}æ–¤`;
            document.getElementById("sidebar-fish").textContent = `${state.inventory.fish}æ¡`;
            document.getElementById("sidebar-craft").textContent = `${state.inventory.craft}ä»¶`;
            
            // æ·»åŠ æ•°å€¼å˜åŒ–åŠ¨ç”»æ•ˆæœ
            const silverEl = document.getElementById("sidebar-silver");
            const filialEl = document.getElementById("sidebar-filial");
            
            if (silverEl) silverEl.classList.add("stat-change");
            if (filialEl) filialEl.classList.add("stat-change");
            
            setTimeout(() => {
                if (silverEl) silverEl.classList.remove("stat-change");
                if (filialEl) filialEl.classList.remove("stat-change");
            }, 500);
            
            // æ£€æŸ¥å­å¿ƒå€¼é˜ˆå€¼
            checkFilialThresholds();
        }

        // åœºæ™¯åˆ‡æ¢
        function goto(scene) {
            if (!state.gameStarted) return;
            
            state.scene = scene;
            const passageDiv = document.getElementById("passage");
            
            // æ¯å¤©å¢åŠ éšæœºäº‹ä»¶æ¦‚ç‡
            state.days++;
            if (state.days - state.lastRandomEvent > 2 && Math.random() < 0.3) {
                triggerRandomEvent();
            }
            
            switch(scene) {
                case "MainScene":
                    renderMainScene(passageDiv);
                    break;
                    
                case "kitchen":
                    renderKitchen(passageDiv);
                    break;
                    
                case "market":
                    renderMarket(passageDiv);
                    break;
                    
                case "tasks":
                    renderTasks(passageDiv);
                    break;
                    
                case "ancestor-hall":
                    renderAncestorHall(passageDiv);
                    break;
            }
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            state.gameStarted = true;
            state.timer = setInterval(updateTimer, 1000);
            goto("MainScene");
        }

        // æ˜¾ç¤ºç»“å±€
        function showEnding() {
            const passageDiv = document.getElementById("passage");
            let endingHtml = "";
            
            // æ ¹æ®å­å¿ƒå€¼ç¡®å®šç»“å±€
            if (state.filial >= 150) {
                endingHtml = `
                    <div class="panel">
                        <h2>å®Œç¾ç»“å±€ï¼šå¾·é«˜æœ›é‡</h2>
                        <p>ä½ çš„å­å¿ƒæ„Ÿå¤©åŠ¨åœ°ï¼Œå®¶æ—å£°èª‰è¾¾åˆ°é¡¶å³°ã€‚ä½ æˆåŠŸä¼ æ‰¿äº†ä¼˜è‰¯å®¶é£ï¼Œæˆä¸ºå½“åœ°çš„æ¥·æ¨¡ã€‚</p>
                        <p>æœ€ç»ˆè¯„ä»·ï¼š</p>
                        <ul>
                            <li>å­å¿ƒå€¼ï¼š${state.filial}</li>
                            <li>é“¶å…ƒï¼š${state.silver}</li>
                            <li>è§£é”æˆå°±ï¼šå…¨éƒ¨3é¡¹</li>
                        </ul>
                        <button onclick="resetGame()">é‡æ–°å¼€å§‹</button>
                    </div>
                `;
            } else if (state.filial >= 100) {
                endingHtml = `
                    <div class="panel">
                        <h2>è‰¯å¥½ç»“å±€ï¼šå®¶æ—æ¥·æ¨¡</h2>
                        <p>ä½ ä»¥å­ä¸ºå…ˆï¼Œå®¶æ—å’Œç¦å…´æ—ºã€‚ä½ çš„è¡Œä¸ºä¸ºåä»£æ ‘ç«‹äº†æ¦œæ ·ï¼Œå®¶é£å¾—ä»¥ä¼ æ‰¿ã€‚</p>
                        <p>æœ€ç»ˆè¯„ä»·ï¼š</p>
                        <ul>
                            <li>å­å¿ƒå€¼ï¼š${state.filial}</li>
                            <li>é“¶å…ƒï¼š${state.silver}</li>
                            <li>è§£é”æˆå°±ï¼š2é¡¹</li>
                        </ul>
                        <button onclick="resetGame()">é‡æ–°å¼€å§‹</button>
                    </div>
                `;
            } else if (state.filial >= 70) {
                endingHtml = `
                    <div class="panel">
                        <h2>æ™®é€šç»“å±€ï¼šåˆéœ²é”‹èŠ’</h2>
                        <p>ä½ å·²åˆæ­¥å±•ç°å­å¿ƒï¼Œå®¶æ—ç¨³æ­¥å‘å±•ã€‚ç»§ç»­åŠªåŠ›ï¼Œå®šèƒ½å…‰å¤§ç¥–ä¸šã€‚</p>
                        <p>æœ€ç»ˆè¯„ä»·ï¼š</p>
                        <ul>
                            <li>å­å¿ƒå€¼ï¼š${state.filial}</li>
                            <li>é“¶å…ƒï¼š${state.silver}</li>
                            <li>è§£é”æˆå°±ï¼š1é¡¹</li>
                        </ul>
                        <button onclick="resetGame()">é‡æ–°å¼€å§‹</button>
                    </div>
                `;
            } else {
                endingHtml = `
                    <div class="panel">
                        <h2>é—æ†¾ç»“å±€ï¼šæœªå°½å­é“</h2>
                        <p>æ—¶é—´æœ‰é™ï¼Œä½ æœªèƒ½å……åˆ†å±•ç°å­å¿ƒã€‚å®¶æ—å‘å±•å—åˆ°å½±å“ï¼Œéœ€æ›´åŠ åŠªåŠ›ã€‚</p>
                        <p>æœ€ç»ˆè¯„ä»·ï¼š</p>
                        <ul>
                            <li>å­å¿ƒå€¼ï¼š${state.filial}</li>
                            <li>é“¶å…ƒï¼š${state.silver}</li>
                            <li>è§£é”æˆå°±ï¼š0é¡¹</li>
                        </ul>
                        <button onclick="resetGame()">é‡æ–°å¼€å§‹</button>
                    </div>
                `;
            }
            
            passageDiv.innerHTML = endingHtml;
        }

        // é‡ç½®æ¸¸æˆ
        function resetGame() {
            // é‡ç½®çŠ¶æ€
            state.silver = 8;
            state.filial = 50;
            state.scene = "start";
            state.tasks = [];
            state.lastRandomEvent = 0;
            state.days = 0;
            state.inventory = {
                rice: 0,
                fish: 0,
                craft: 3
            };
            state.achievements = {
                "achievement-1": false,
                "achievement-2": false,
                "achievement-3": false
            };
            state.unlockedFeatures = [];
            state.gameTime = 5 * 60;
            state.gameStarted = false;
            
            // é‡ç½®UI
            clearInterval(state.timer);
            document.getElementById("sidebar-time").textContent = "5:00";
            document.getElementById("time-display").classList.remove("time-alert");
            updateUI();
            
            // é‡ç½®æˆå°±æ˜¾ç¤º
            for (const key of Object.keys(state.achievements)) {
                const statusEl = document.getElementById(`${key}-status`);
                if (statusEl) {
                    statusEl.textContent = "æœªè§£é”";
                    statusEl.className = "";
                }
            }
            
            // æ˜¾ç¤ºå¼€å§‹ç•Œé¢
            const passageDiv = document.getElementById("passage");
            passageDiv.innerHTML = `
                <div class="panel">
                    <h2>ç¬¬1ä»£ï¼šç“¯æ±Ÿå®¶é£</h2>
                    <p>ä½ å°†åœ¨5åˆ†é’Ÿå†…ç®¡ç†å®¶æ—äº‹åŠ¡ï¼Œç§¯ç´¯å­å¿ƒå€¼å’Œè´¢å¯Œã€‚</p>
                    <button onclick="startGame()">å¼€å§‹ä¼ æ‰¿ä¹‹æ—…</button>
                </div>
            `;
        }

        // æ¸²æŸ“ä¸»åœºæ™¯
        function renderMainScene(passageDiv) {
            // ç”Ÿæˆéšæœºä»»åŠ¡
            generateTasks();
            
            const taskCount = state.tasks.filter(t => !t.completed).length;
            const taskBadge = taskCount > 0 ? `<span class="badge">${taskCount}</span>` : '';
            
            // æ£€æŸ¥æ˜¯å¦è§£é”å®—ç¥ 
            const ancestorHallBtn = state.unlockedFeatures.includes("ancestor-hall") 
                ? `<button onclick="goto('ancestor-hall')">å®—ç¥ </button>` 
                : '';
            
            passageDiv.innerHTML = `
                <div class="panel">
                    <h3>ä¸»åœºæ™¯</h3>
                    <div class="btn-group">
                        <button onclick="goto('kitchen')">å¨æˆ¿</button>
                        <button onclick="goto('market')">å¸‚é›†</button>
                        <button onclick="goto('tasks')">
                            å®¶æ—ä»»åŠ¡${taskBadge}
                        </button>
                    </div>
                    <button onclick="takeCareMother()">ç…§é¡¾æ¯äº²</button>
                    <button onclick="visitNeighbor()">æ‹œè®¿é‚»å±…</button>
                    ${ancestorHallBtn}
                    <button onclick="goto('start')">è¿”å›å¼€å§‹</button>
                </div>
            `;
        }

        // æ¸²æŸ“å¨æˆ¿
        function renderKitchen(passageDiv) {
            passageDiv.innerHTML = `
                <div class="panel">
                    <h3>å¨æˆ¿</h3>
                    <button onclick="cookRice()" ${state.inventory.rice < 1 ? 'disabled' : ''}>
                        ç…®é¥­ (æ¶ˆè€—1æ–¤ç±³ï¼Œ+3å­å¿ƒå€¼)
                    </button>
                    <button onclick="cookFish()" ${state.inventory.fish < 1 ? 'disabled' : ''}>
                        è’¸é±¼ (æ¶ˆè€—1æ¡é±¼ï¼Œ+5å­å¿ƒå€¼)
                    </button>
                    <button onclick="goto('MainScene')">è¿”å›</button>
                </div>
            `;
        }

        // æ¸²æŸ“å¸‚é›†
        function renderMarket(passageDiv) {
            passageDiv.innerHTML = `
                <div class="panel">
                    <h3>å¸‚é›†</h3>
                    <button onclick="buyRice()">ä¹°ç±³ (2é“¶å…ƒ/æ–¤)</button>
                    <button onclick="buyFish()">ä¹°é±¼ (3é“¶å…ƒ/æ¡)</button>
                    <button onclick="sellCraft()" ${state.inventory.craft < 1 ? 'disabled' : ''}>
                        å‡ºå”®æ‰‹å·¥è‰ºå“ (5é“¶å…ƒ/ä»¶)
                    </button>
                    <button onclick="donate()">å‘å®—ç¥ ææ¬¾ (10é“¶å…ƒï¼Œ+15å­å¿ƒå€¼)</button>
                    <button onclick="goto('MainScene')">è¿”å›</button>
                </div>
            `;
        }

        // æ¸²æŸ“å®—ç¥ 
        function renderAncestorHall(passageDiv) {
            passageDiv.innerHTML = `
                <div class="panel">
                    <h3>å®—ç¥ </h3>
                    <p>è¿™é‡Œä¾›å¥‰ç€å®¶æ—çš„ç¥–å…ˆç‰Œä½ã€‚</p>
                    <button onclick="prayAncestor()">ç¥­æ‹œç¥–å…ˆ (+5å­å¿ƒå€¼)</button>
                    <button onclick="expandAncestorHall()">æ‰©å»ºå®—ç¥  (50é“¶å…ƒï¼Œ+20å­å¿ƒå€¼)</button>
                    <button onclick="goto('MainScene')">è¿”å›</button>
                </div>
            `;
        }

        // æ¸²æŸ“ä»»åŠ¡é¢æ¿
        function renderTasks(passageDiv) {
            const tasksHtml = state.tasks
                .map(task => `
                    <div class="task ${task.completed ? 'opacity-50' : ''}">
                        <h4>${task.title}</h4>
                        <p>${task.description}</p>
                        ${task.completed 
                            ? `<div class="success">å·²å®Œæˆï¼šè·å¾—${task.reward}å­å¿ƒå€¼å’Œ${task.silverReward}é“¶å…ƒ</div>` 
                            : `<button onclick="completeTask('${task.id}')">å®Œæˆä»»åŠ¡ (+${task.reward}å­å¿ƒå€¼ï¼Œ+${task.silverReward}é“¶å…ƒ)</button>`
                        }
                    </div>
                `)
                .join('');
                
            passageDiv.innerHTML = `
                <div class="panel">
                    <h3>å®¶æ—ä»»åŠ¡</h3>
                    ${tasksHtml || '<p>æš‚æ— ä»»åŠ¡</p>'}
                    <button onclick="goto('MainScene')">è¿”å›</button>
                </div>
            `;
        }

        // ç…§é¡¾æ¯äº²
        function takeCareMother() {
            if (state.silver >= 2) {
                state.silver -= 2;
                state.filial += 10;
                showAlert("success", "ä½ ç²¾å¿ƒç…§æ–™äº†æ¯äº²ï¼Œå­å¿ƒå€¼å¢åŠ 10ç‚¹ã€‚");
                updateUI();
            } else {
                showAlert("error", "ä½ æ²¡æœ‰è¶³å¤Ÿçš„é“¶å…ƒæ¥ç…§é¡¾æ¯äº²ï¼");
            }
        }

        // ç…®é¥­
        function cookRice() {
            if (state.inventory.rice >= 1) {
                state.inventory.rice -= 1;
                state.filial += 3;
                showAlert("success", "ä½ ç…®äº†ä¸€é”…ç±³é¥­ï¼Œå­å¿ƒå€¼å¢åŠ 3ç‚¹ã€‚");
                updateUI();
            } else {
                showAlert("error", "ä½ æ²¡æœ‰è¶³å¤Ÿçš„å¤§ç±³ï¼");
            }
        }

        // è’¸é±¼
        function cookFish() {
            if (state.inventory.fish >= 1) {
                state.inventory.fish -= 1;
                state.filial += 5;
                showAlert("success", "ä½ è’¸äº†ä¸€æ¡é±¼ï¼Œå®¶äººèµä¸ç»å£ã€‚å­å¿ƒå€¼å¢åŠ 5ç‚¹ã€‚");
                updateUI();
            } else {
                showAlert("error", "ä½ æ²¡æœ‰è¶³å¤Ÿçš„é±¼ï¼");
            }
        }

        // ä¹°ç±³
        function buyRice() {
            if (state.silver >= 2) {
                state.silver -= 2;
                state.inventory.rice += 1;
                showAlert("success", "ä½ è´­ä¹°äº†1æ–¤ç±³ï¼ŒèŠ±è´¹2é“¶å…ƒã€‚");
                updateUI();
            } else {
                showAlert("error", "ä½ æ²¡æœ‰è¶³å¤Ÿçš„é“¶å…ƒï¼");
            }
        }

        // ä¹°é±¼
        function buyFish() {
            if (state.silver >= 3) {
                state.silver -= 3;
                state.inventory.fish += 1;
                showAlert("success", "ä½ è´­ä¹°äº†1æ¡é±¼ï¼ŒèŠ±è´¹3é“¶å…ƒã€‚");
                updateUI();
            } else {
                showAlert("error", "ä½ æ²¡æœ‰è¶³å¤Ÿçš„é“¶å…ƒï¼");
            }
        }

        // å‡ºå”®æ‰‹å·¥è‰ºå“
        function sellCraft() {
            if (state.inventory.craft >= 1) {
                state.inventory.craft -= 1;
                state.silver += 5;
                showAlert("success", "ä½ å‡ºå”®äº†ä¸€ä»¶æ‰‹å·¥è‰ºå“ï¼Œè·å¾—5é“¶å…ƒã€‚");
                updateUI();
            } else {
                showAlert("error", "ä½ æ²¡æœ‰æ‰‹å·¥è‰ºå“å¯å‡ºå”®ï¼");
            }
        }

        // å‘å®—ç¥ ææ¬¾
        function donate() {
            if (state.silver >= 10) {
                state.silver -= 10;
                state.filial += 15;
                showAlert("success", "ä½ å‘å®—ç¥ ææ¬¾10é“¶å…ƒï¼Œå­å¿ƒå€¼å¢åŠ 15ç‚¹ã€‚");
                updateUI();
            } else {
                showAlert("error", "ä½ æ²¡æœ‰è¶³å¤Ÿçš„é“¶å…ƒï¼");
            }
        }

        // æ‹œè®¿é‚»å±…
        function visitNeighbor() {
            const randomGain = Math.floor(Math.random() * 7) + 3; // 3-9ç‚¹å­å¿ƒå€¼
            const randomSilver = Math.floor(Math.random() * 4) + 1; // 1-4é“¶å…ƒ
            
            state.filial += randomGain;
            state.silver += randomSilver;
            
            showAlert("success", `ä½ æ‹œè®¿äº†é‚»å±…ï¼Œè·å¾—${randomGain}ç‚¹å­å¿ƒå€¼å’Œ${randomSilver}é“¶å…ƒã€‚`);
            updateUI();
        }

        // ç¥­æ‹œç¥–å…ˆ
        function prayAncestor() {
            state.filial += 5;
            showAlert("success", "ä½ è™”è¯šåœ°ç¥­æ‹œäº†ç¥–å…ˆï¼Œå­å¿ƒå€¼å¢åŠ 5ç‚¹ã€‚");
            updateUI();
        }

        // æ‰©å»ºå®—ç¥ 
        function expandAncestorHall() {
            if (state.silver >= 50) {
                state.silver -= 50;
                state.filial += 20;
                showAlert("success", "ä½ æ‰©å»ºäº†å®—ç¥ ï¼Œå®¶æ—å£°èª‰æå‡ï¼Œå­å¿ƒå€¼å¢åŠ 20ç‚¹ã€‚");
                updateUI();
            } else {
                showAlert("error", "ä½ æ²¡æœ‰è¶³å¤Ÿçš„é“¶å…ƒæ‰©å»ºå®—ç¥ ï¼");
            }
        }

        // ç”Ÿæˆéšæœºä»»åŠ¡
        function generateTasks() {
            // æœ€å¤šåŒæ—¶å­˜åœ¨3ä¸ªä»»åŠ¡
            if (state.tasks.filter(t => !t.completed).length >= 3) return;
            
            // æœ‰50%æ¦‚ç‡ç”Ÿæˆæ–°ä»»åŠ¡
            if (Math.random() < 0.5) {
                const baseTasks = [
                    {
                        id: "task1",
                        title: "æ•´ç†æ—è°±",
                        description: "å®¶æ—æ—è°±éœ€è¦æ•´ç†ï¼Œè¿™å°†å¸®åŠ©åäººäº†è§£å®¶æ—å†å²ã€‚",
                        reward: 12,
                        silverReward: 5,
                        completed: false
                    },
                    {
                        id: "task2",
                        title: "ä¿®ç¼®ç¥–åŸ",
                        description: "ç¥–åŸå¹´ä¹…å¤±ä¿®ï¼Œéœ€è¦å‡ºèµ„ä¿®ç¼®ä»¥è¡¨å­å¿ƒã€‚",
                        reward: 18,
                        silverReward: 8,
                        completed: false
                    },
                    {
                        id: "task3",
                        title: "æ•™å¯¼æ™šè¾ˆ",
                        description: "æ•™å¯¼å®¶æ—ä¸­çš„æ™šè¾ˆå­¦ä¹ ä¼ ç»Ÿç¤¼ä»ªã€‚",
                        reward: 10,
                        silverReward: 3,
                        completed: false
                    },
                    {
                        id: "task4",
                        title: "æ”¶é›†å®¶è®­",
                        description: "æ”¶é›†å®¶æ—ä¸­çš„å¤è€å®¶è®­ï¼Œä¼ æ‰¿å®¶æ—ç²¾ç¥ã€‚",
                        reward: 15,
                        silverReward: 6,
                        completed: false
                    }
                ];
                
                // è¿‡æ»¤å·²å®Œæˆçš„ä»»åŠ¡
                const availableTasks = baseTasks.filter(t => 
                    !state.tasks.some(st => st.id === t.id && st.completed)
                );
                
                if (availableTasks.length > 0) {
                    const newTask = availableTasks[Math.floor(Math.random() * availableTasks.length)];
                    // é¿å…é‡å¤æ·»åŠ ç›¸åŒä»»åŠ¡
                    if (!state.tasks.some(t => t.id === newTask.id && !t.completed)) {
                        state.tasks.push({...newTask});
                    }
                }
            }
        }

        // å®Œæˆä»»åŠ¡
        function completeTask(taskId) {
            const task = state.tasks.find(t => t.id === taskId);
            if (task && !task.completed) {
                task.completed = true;
                state.filial += task.reward;
                state.silver += task.silverReward;
                
                showAlert("success", `ä½ å®Œæˆäº†ä»»åŠ¡ "${task.title}"ï¼Œè·å¾—${task.reward}ç‚¹å­å¿ƒå€¼å’Œ${task.silverReward}é“¶å…ƒï¼`);
                updateUI();
                
                // åˆ·æ–°ä»»åŠ¡é¢æ¿
                if (state.scene === "tasks") {
                    renderTasks(document.getElementById("passage"));
                }
            }
        }

        // è§¦å‘éšæœºäº‹ä»¶
        function triggerRandomEvent() {
            state.lastRandomEvent = state.days;
            
            const events = [
                {
                    type: "positive",
                    title: "é‚»é‡Œç§°èµ",
                    description: "ä½ çš„å­å¿ƒæ„ŸåŠ¨äº†é‚»é‡Œï¼Œå¤§å®¶çº·çº·ç§°èµã€‚",
                    effect: () => {
                        const gain = Math.floor(Math.random() * 8) + 3; // 3-10
                        state.filial += gain;
                        return `å­å¿ƒå€¼ +${gain}`;
                    }
                },
                {
                    type: "positive",
                    title: "ç¥–å…ˆåº‡ä½‘",
                    description: "ç¥­ç¥–æ˜¾çµï¼Œç¥–å…ˆä¿ä½‘å®¶æ—å¹³å®‰ã€‚",
                    effect: () => {
                        const gain = Math.floor(Math.random() * 10) + 5; // 5-14
                        state.silver += gain;
                        return `é“¶å…ƒ +${gain}`;
                    }
                },
                {
                    type: "negative",
                    title: "è‡ªç„¶ç¾å®³",
                    description: "çªå‘æ´ªæ°´ï¼Œå†²æ¯äº†éƒ¨åˆ†åº„ç¨¼ã€‚",
                    effect: () => {
                        const loss = Math.min(2, state.inventory.rice);
                        state.inventory.rice = Math.max(0, state.inventory.rice - loss);
                        return loss > 0 ? `æŸå¤±${loss}æ–¤å¤§ç±³` : "å¹¸æ— æŸå¤±";
                    }
                },
                {
                    type: "negative",
                    title: "å®¶æ—çº·äº‰",
                    description: "å®¶æ—å†…éƒ¨å‘ç”Ÿçº·äº‰ï¼Œå½±å“äº†å®¶æ—å£°èª‰ã€‚",
                    effect: () => {
                        const loss = Math.floor(Math.random() * 8) + 3; // 3-10
                        state.filial -= loss;
                        return `å­å¿ƒå€¼ -${loss}`;
                    }
                },
                {
                    type: "neutral",
                    title: "å•†æœºå‡ºç°",
                    description: "å¶ç„¶å‘ç°ä¸€ä¸ªå°å•†æœºã€‚",
                    effect: () => {
                        if (state.silver >= 4) {
                            const cost = 4;
                            const profit = Math.floor(Math.random() * 12) + 6; // 6-17
                            state.silver -= cost;
                            state.silver += profit;
                            return `æŠ•èµ„${cost}é“¶å…ƒï¼Œè·å¾—${profit}é“¶å…ƒå›æŠ¥`;
                        } else {
                            return "ä½ æ²¡æœ‰è¶³å¤Ÿçš„é“¶å…ƒæŠ•èµ„";
                        }
                    }
                }
            ];
            
            const randomEvent = events[Math.floor(Math.random() * events.length)];
            const effectText = randomEvent.effect();
            
            const alertType = randomEvent.type === "positive" ? "success" : 
                             randomEvent.type === "negative" ? "error" : "warning";
                             
            showAlert(alertType, `${randomEvent.title}<br>${randomEvent.description}<br>${effectText}`);
            updateUI();
        }

        // æ˜¾ç¤ºæç¤º
        function showAlert(type, message) {
            const alertDiv = document.createElement("div");
            alertDiv.className = `alert ${type}`;
            alertDiv.innerHTML = message;
            
            const storyDiv = document.getElementById("story");
            storyDiv.insertBefore(alertDiv, storyDiv.firstChild);
            
            // 3ç§’åç§»é™¤æç¤º
            setTimeout(() => {
                alertDiv.style.opacity = "0";
                setTimeout(() => alertDiv.remove(), 300);
            }, 5000);
        }
        
        // åˆå§‹åŒ–æ˜¾ç¤º
        updateUI();
    </script>
</body>
</html>
